{{- $url := .Get "url" -}}
{{ $title := .Get "title" | default (.Inner | markdownify | plainify | chomp) | default (path.Base $url) }}
{{- $page := .Get "page" | default "1" -}}
{{- $id := printf "pdf-modal-%s-%s" (substr ($url | md5) 0 8) $page -}}

{{- if not ($.Page.Scratch.Get "pdf-modal-included") -}}
<link rel="stylesheet" href="/css/pdf-viewer.css">
<script src="/js/pdf-js/build/pdf.js"></script>
{{- $.Page.Scratch.Set "pdf-modal-included" true -}}
{{- end }}


{{- $as := .Get "as" | default "button" -}}
{{ if eq $as "link" }}
  <a href="javascript:void(0);" onclick="openPdfModal('{{ $id }}', {{ $page }})">{{ .Inner | markdownify }}</a>
{{ else }}
  <a href="javascript:void(0);" class="book-btn"  onclick="openPdfModal('{{ $id }}', {{ $page }})">{{ .Inner | markdownify }}</a>
{{ end }}

<div id="{{ $id }}" class="pdf-modal-overlay" style="display:none;">
  <div class="pdf-modal-content" onclick="event.stopPropagation();">
    <div class="pdf-modal-header">
      <div class="pdf-modal-title">
        <h3>{{ $title }}</h3>
        <a href="{{ $url }}" download title="Télécharger">{{ path.Base $url }}</a>
      </div>
      <span class="pdf-modal-close" onclick="closePdfModal('{{ $id }}')">&times;</span>
    </div>
    <div class="pdf-modal-body">
      {{ partial "pdf-embed.html" (dict "url" $url "page" $page "id" $id) }}
    </div>
    <div class="pdf-modal-footer">
      <button id="pdf-prev-{{ $id }}">←</button>
      <span>
        <span id="pdf-pagenum-{{ $id }}"></span> / <span id="pdf-pagecount-{{ $id }}"></span>
      </span>
      <button id="pdf-next-{{ $id }}">→</button>
    </div>
  </div>
</div>



<script>
function openPdfModal(id) {
  var overlay = document.getElementById(id);
  overlay.style.display = 'flex';
  // Fermer avec clic overlay
  overlay.onclick = function(e) {
    if (e.target === overlay) closePdfModal(id);
  };
  // Fermer avec Échap
  document.addEventListener('keydown', function escListener(ev) {
    if (ev.key === 'Escape') {
      closePdfModal(id);
      document.removeEventListener('keydown', escListener);
    }
  });
}
function closePdfModal(id) {
  var overlay = document.getElementById(id);
  overlay.style.display = 'none';
  overlay.onclick = null;
}
</script>
